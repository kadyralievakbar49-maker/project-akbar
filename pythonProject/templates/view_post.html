{% extends "base.html" %}

{% block title %}{{ post.title }} - –§–æ—Ä—É–º{% endblock %}

{% block content %}
    <h1 style="margin-bottom: 20px; color: #2c3e50;">{{ post.title }}</h1>

    <div style="border: 1px solid #ddd; padding: 25px; margin-bottom: 25px; border-radius: 10px; background-color: #f9f9f9;">
        <div style="margin-bottom: 15px;">
            <p style="font-size: 1.1em; line-height: 1.7;">{{ post.content }}</p>
        </div>
        <div style="color: #7f8c8d; font-size: 0.95em; border-top: 1px solid #eee; padding-top: 15px;">
            <p>
                –ê–≤—Ç–æ—Ä: <strong>{{ post.author.username }}</strong> |
                –î–∞—Ç–∞: {{ post.created_at.strftime('%d.%m.%Y %H:%M') }}
            </p>
        </div>

        {% if session.user_id == post.user_id %}
            <div style="margin-top: 15px; text-align: right;">
                <a href="{{ url_for('delete_post', post_id=post.id) }}" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')" style="color: #e74c3c; text-decoration: none; font-weight: bold;">‚ùå –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç</a>
            </div>
        {% endif %}
    </div>

    <h2 style="margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center;">
        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comments|length }})
    </h2>

    {% if post.comments %}
        {% for comment in post.comments|sort(attribute='created_at') %}
            <div class="comment-block" style="border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: white; position: relative;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <div>
                        {% if comment.is_anonymous %}
                            <strong style="color: #95a5a6;">–ê–Ω–æ–Ω–∏–º</strong>
                            <span class="anonymous-badge">–ê–Ω–æ–Ω–∏–º–Ω–æ</span>
                        {% else %}
                            <strong style="color: #3498db;">{{ comment.author.username }}</strong>
                        {% endif %}
                    </div>
                    <span style="color: #95a5a6; font-size: 0.9em;">
                        {{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}
                        {% if comment.updated_at %}
                            <span style="color: #f39c12; font-size: 0.8em;">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>
                        {% endif %}
                    </span>
                </div>
                <p style="margin-bottom: 10px; line-height: 1.6;">{{ comment.content }}</p>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;">
                    <div>
                        {% if not comment.is_anonymous and session.user_id == comment.user_id %}
                            <a href="{{ url_for('edit_comment', comment_id=comment.id) }}" style="color: #3498db; font-size: 0.9em; text-decoration: none; margin-right: 10px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                            <a href="{{ url_for('delete_comment', comment_id=comment.id) }}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')" style="color: #e74c3c; font-size: 0.9em; text-decoration: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                        {% elif comment.is_anonymous and session.user_id == post.user_id %}
                            <a href="{{ url_for('delete_comment', comment_id=comment.id) }}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')" style="color: #e74c3c; font-size: 0.9em; text-decoration: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (–∞–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞)</a>
                        {% elif session.is_admin %}
                            <a href="{{ url_for('delete_comment', comment_id=comment.id) }}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä?')" style="color: #e74c3c; font-size: 0.9em; text-decoration: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (–∞–¥–º–∏–Ω)</a>
                        {% endif %}
                    </div>
                    <button class="ai-btn" data-comment-id="{{ comment.id }}" style="background-color: #9b59b6; color: white; border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ò–ò
                    </button>
                </div>

                <!-- –ú–µ—Å—Ç–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ò–ò -->
                <div class="ai-response" id="ai-response-{{ comment.id }}" style="margin-top: 15px; padding: 12px; background-color: #f8f9fa; border-left: 3px solid #9b59b6; border-radius: 0 6px 6px 0; display: none;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <div style="background-color: #9b59b6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: bold;">ü§ñ</div>
                        <div>
                            <div style="font-weight: bold; color: #9b59b6; margin-bottom: 5px;">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                            <div class="ai-response-content" id="ai-response-content-{{ comment.id }}"></div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 30px; background-color: #f8f9fa; border-radius: 8px; color: #95a5a6;">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        </div>
    {% endif %}

    <h3 style="margin: 30px 0 15px; color: #2c3e50;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>

    <form method="POST" action="{{ url_for('view_post', post_id=post.id) }}">
        <div style="margin-bottom: 15px;">
            <textarea name="content" required rows="5" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; resize: vertical;" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
        </div>

        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; background-color: #f8f9fa; padding: 12px; border-radius: 6px;">
            <input type="checkbox" id="is_anonymous" name="is_anonymous" style="width: 18px; height: 18px;">
            <label for="is_anonymous" style="font-size: 0.95em; color: #2c3e50;">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ <span style="color: #95a5a6; font-size: 0.9em;">(–≤–∞—à–µ –∏–º—è –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ)</span>
            </label>
        </div>

        <button type="submit" style="padding: 12px 25px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s;">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        </button>

        {% if not session.username %}
            <p style="margin-top: 10px; color: #e67e22; font-size: 0.95em;">
                <i>üí° –°–æ–≤–µ—Ç:</i> –í—ã –º–æ–∂–µ—Ç–µ <a href="{{ url_for('login') }}" style="color: #3498db; text-decoration: underline;">–≤–æ–π—Ç–∏</a> –∏–ª–∏ <a href="{{ url_for('register') }}" style="color: #2ecc71; text-decoration: underline;">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a> –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è, –ª–∏–±–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
            </p>
        {% endif %}
    </form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–ø—Ä–æ—Å–∏—Ç—å –ò–ò"
    document.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const aiResponseBlock = document.getElementById('ai-response-' + commentId);
            const aiResponseContent = document.getElementById('ai-response-content-' + commentId);
            const buttonElement = this;

            // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å - —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (aiResponseBlock.style.display === 'block') {
                aiResponseBlock.style.display = 'none';
                buttonElement.innerHTML = 'ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ò–ò';
                return;
            }

            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–î—É–º–∞—é..."
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'ü§î –î—É–º–∞—é...';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
            fetch(`/ai_assistant/${commentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ò–ò
                        aiResponseContent.innerHTML = data.response
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                            .replace(/\*(.*?)\*/g, '<em>$1</em>');  // –ö—É—Ä—Å–∏–≤

                        aiResponseBlock.style.display = 'block';
                        buttonElement.innerHTML = '‚úÖ –ò–ò –æ—Ç–≤–µ—Ç–∏–ª';

                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ—Ç–≤–µ—Ç—É –ò–ò
                        aiResponseBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –ò–ò');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                })
                .finally(() => {
                    buttonElement.disabled = false;
                    // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                    setTimeout(() => {
                        if (aiResponseBlock.style.display === 'block') {
                            buttonElement.innerHTML = '‚úÖ –ò–ò –æ—Ç–≤–µ—Ç–∏–ª';
                        } else {
                            buttonElement.innerHTML = 'ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ò–ò';
                        }
                    }, 3000);
                });
        });
    });
});
</script>
{% endblock %}